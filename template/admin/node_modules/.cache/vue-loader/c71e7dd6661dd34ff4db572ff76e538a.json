{"remainingRequest":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/Volumes/mac/webwork/2023/dati/template/admin/node_modules/iview-loader/index.js??ref--0-2!/Volumes/mac/webwork/2023/dati/template/admin/src/pages/system/maintain/systemDatabackup/index.vue?vue&type=style&index=0&id=516cf2e6&scoped=true&lang=stylus&","dependencies":[{"path":"/Volumes/mac/webwork/2023/dati/template/admin/src/pages/system/maintain/systemDatabackup/index.vue","mtime":1689324015278},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/@vue/cli-service/node_modules/css-loader/index.js","mtime":499162500000},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/vue-loader/lib/loaders/stylePostLoader.js","mtime":499162500000},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/postcss-loader/src/index.js","mtime":499162500000},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/stylus-loader/index.js","mtime":1519606876000},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000},{"path":"/Volumes/mac/webwork/2023/dati/template/admin/node_modules/iview-loader/index.js","mtime":1570440814000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKLnRhYmxlQm94ID4+PiAuaXZ1LXRhYmxlLWhlYWRlciB0YWJsZQogICBib3JkZXIgbm9uZSAhaW1wb3J0YW50CgoudGFibGUtbWFya3sKICBjdXJzb3I6IHRleHQ7Cn0KLnRhYmxlLW1hcms6aG92ZXJ7CiAgYm9yZGVyOjFweCBzb2xpZCAjYzJjMmMyOwogIHBhZGRpbmc6IDNweCA1cHgKfQoubWFyayAvZGVlcC8gLml2dS1pbnB1dHsKICAgIGJhY2tncm91bmQ6ICNmZmY7CiAgICBib3JkZXItcmFkaXVzOiAuMzlyZW07Cn0KLm1hcmsgL2RlZXAvIC5pdnUtaW5wdXQsIC5pdnUtaW5wdXQ6aG92ZXIsIC5pdnUtaW5wdXQ6Zm9jdXMgewogICAgYm9yZGVyOiB0cmFuc3BhcmVudDsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0K"},{"version":3,"sources":["index.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAwcA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/pages/system/maintain/systemDatabackup","sourcesContent":["<template>\n  <div>\n    <Card :bordered=\"false\" dis-hover class=\"ivu-mt listbox\">\n      <Tabs class=\"mb30\">\n        <TabPane label=\"数据库列表\">\n          <Card :bordered=\"false\" dis-hover class=\"tableBox mt10\">\n            <div slot=\"title\">\n              <!--              <span class=\"ivu-pl-8 mr10\">数据库表列表</span>-->\n              <Button type=\"primary\" class=\"mr10\" @click=\"getBackup\">备份</Button>\n              <Button type=\"primary\" class=\"mr10\" @click=\"getOptimize\">优化表</Button>\n              <Button type=\"primary\" class=\"mr10\" @click=\"getRepair\">修复表</Button>\n              <Button type=\"primary\" class=\"mr10\" @click=\"exportData(1)\">导出文件</Button>\n            </div>\n            <Table\n              ref=\"selection\"\n              :columns=\"columns\"\n              :data=\"tabList2\"\n              :loading=\"loading\"\n              no-data-text=\"暂无数据\"\n              @on-selection-change=\"onSelectTab\"\n              size=\"small\"\n              no-filtered-data-text=\"暂无筛选结果\"\n            >\n              <template slot-scope=\"{ row, index }\" slot=\"comment\">\n                <div class=\"mark\">\n                  <div v-if=\"row.is_edit\" class=\"table-mark\" @click=\"isEditMark(row)\">{{ row.comment }}</div>\n                  <Input ref=\"mark\" v-else v-model=\"row.comment\" @on-blur=\"isEditBlur(row, 0)\"></Input>\n                </div>\n              </template>\n              <template slot-scope=\"{ row }\" slot=\"action\">\n                <a @click=\"Info(row)\">详情</a>\n              </template>\n            </Table>\n          </Card>\n          <!-- 详情模态框-->\n          <Drawer :closable=\"false\" width=\"740\" v-model=\"modals\" :title=\"'[ ' + rows.name + ' ]' + rows.comment\">\n            <Table\n              ref=\"selection\"\n              :columns=\"columns2\"\n              :data=\"tabList3\"\n              :loading=\"loading2\"\n              no-data-text=\"暂无数据\"\n              max-height=\"600\"\n              size=\"small\"\n              no-filtered-data-text=\"暂无筛选结果\"\n            >\n              <template slot-scope=\"{ row, index }\" slot=\"COLUMN_COMMENT\">\n                <div class=\"mark\">\n                  <div v-if=\"row.is_edit\" class=\"table-mark\" @click=\"isEditMark(row)\">{{ row.COLUMN_COMMENT }}</div>\n                  <Input ref=\"mark\" v-else v-model=\"row.COLUMN_COMMENT\" @on-blur=\"isEditBlur(row, 1)\"></Input>\n                </div>\n              </template>\n            </Table>\n          </Drawer>\n        </TabPane>\n        <TabPane label=\"备份列表\">\n          <Card :bordered=\"false\" dis-hover class=\"\">\n            <Table\n              ref=\"selection\"\n              :columns=\"columns4\"\n              :data=\"tabList\"\n              :loading=\"loading3\"\n              no-data-text=\"暂无数据\"\n              highlight-row\n              size=\"small\"\n              no-filtered-data-text=\"暂无筛选结果\"\n            >\n              <template slot-scope=\"{ row, index }\" slot=\"action\">\n                <a @click=\"ImportFile(row)\">导入</a>\n                <Divider type=\"vertical\" />\n                <a @click=\"del(row, '删除该备份', index)\">删除</a>\n                <Divider type=\"vertical\" />\n                <a @click=\"download(row)\">下载</a>\n              </template>\n            </Table>\n          </Card>\n        </TabPane>\n      </Tabs>\n    </Card>\n    <Modal v-model=\"markModal\" title=\"修改备注\" @on-ok=\"ok\" @on-cancel=\"cancel\" @on-visible-change=\"cancel\">\n      <Input v-model=\"mark\"></Input>\n    </Modal>\n  </div>\n</template>\n\n<script>\nimport {\n  backupListApi,\n  backupReadListApi,\n  backupBackupApi,\n  backupOptimizeApi,\n  backupRepairApi,\n  filesListApi,\n  filesDownloadApi,\n  filesImportApi,\n  updateMark,\n} from '@/api/system';\nimport Setting from '@/setting';\nimport { getCookies } from '@/libs/util';\n\nexport default {\n  name: 'systemDatabackup',\n  data() {\n    return {\n      modals: false,\n      loading: false,\n      tabList: [],\n      columns4: [\n        {\n          title: '备份名称',\n          key: 'filename',\n          minWidth: 200,\n          sortable: true,\n        },\n        {\n          title: 'part',\n          key: 'part',\n          minWidth: 100,\n        },\n        {\n          title: '大小',\n          key: 'size',\n          minWidth: 150,\n        },\n        {\n          title: 'compress',\n          key: 'compress',\n          minWidth: 100,\n        },\n        {\n          title: '时间',\n          key: 'backtime',\n          minWidth: 150,\n        },\n        {\n          title: '操作',\n          slot: 'action',\n          fixed: 'right',\n          minWidth: 80,\n        },\n      ],\n      tabList2: [],\n      columns: [\n        {\n          type: 'selection',\n          width: 60,\n          align: 'center',\n        },\n        {\n          title: '表名称',\n          key: 'name',\n          minWidth: 200,\n          sortable: true,\n        },\n        {\n          title: '备注',\n          slot: 'comment',\n          minWidth: 200,\n        },\n        {\n          title: '类型',\n          key: 'engine',\n          minWidth: 130,\n          sortable: true,\n        },\n        {\n          title: '大小',\n          key: 'data_length',\n          minWidth: 130,\n          sortable: true,\n        },\n        {\n          title: '更新时间',\n          key: 'update_time',\n          minWidth: 150,\n          sortable: true,\n        },\n        {\n          title: '行数',\n          key: 'rows',\n          minWidth: 100,\n          sortable: true,\n        },\n        {\n          title: '操作',\n          slot: 'action',\n          fixed: 'right',\n          minWidth: 80,\n        },\n      ],\n      selectionList: [],\n      tabList3: [],\n      columns2: [\n        {\n          title: '字段名',\n          key: 'COLUMN_NAME',\n        },\n        {\n          title: '数据类型',\n          key: 'COLUMN_TYPE',\n        },\n        {\n          title: '默认值',\n          key: 'COLUMN_DEFAULT',\n        },\n        {\n          title: '允许非空',\n          key: 'IS_NULLABLE',\n        },\n        {\n          title: '自动递增',\n          key: 'EXTRA',\n        },\n        {\n          title: '备注',\n          slot: 'COLUMN_COMMENT',\n        },\n      ],\n      rows: {},\n      dataList: {},\n      loading2: false,\n      loading3: false,\n      markModal: false,\n      mark: '',\n      header: {},\n      Token: '',\n      changeMarkData: {\n        table: '',\n        mark: '',\n        type: '',\n        field: '',\n      },\n    };\n  },\n  computed: {\n    fileUrl() {\n      const search = '/adminapi/';\n      const start = Setting.apiBaseURL.indexOf(search);\n      return Setting.apiBaseURL.substring(0, start); // 截取字符串\n    },\n  },\n  created() {\n    this.getToken();\n    this.getList();\n    this.getfileList();\n  },\n  methods: {\n    editMark(row, type) {\n      this.changeMarkData.table = row.name || row.TABLE_NAME;\n      this.changeMarkData.field = row.COLUMN_NAME || '';\n      this.changeMarkData.type = row.COLUMN_TYPE || '';\n      this.changeMarkData.is_field = type;\n      this.markModal = true;\n    },\n    ok() {\n      this.changeMarkData.mark = this.mark;\n      updateMark(this.changeMarkData).then((res) => {\n        this.$Message.success(res.msg);\n        if (this.changeMarkData.is_field) {\n          this.Info({ name: this.changeMarkData.table, comment: this.rows.comment });\n        } else {\n          this.getList();\n        }\n      });\n    },\n    cancel() {\n      this.mark = '';\n    },\n    // 导入\n    ImportFile(row) {\n      filesImportApi({\n        part: row.part,\n        time: row.time,\n      })\n        .then(async (res) => {\n          this.$Message.success(res.msg);\n          this.getfileList();\n        })\n        .catch((res) => {\n          this.loading = false;\n          this.$Message.error(res.msg);\n        });\n    },\n    // 删除备份记录表\n    del(row, tit, num) {\n      let delfromData = {\n        title: tit,\n        num: num,\n        url: `system/backup/del_file`,\n        method: 'DELETE',\n        ids: {\n          filename: row.time,\n        },\n      };\n      this.$modalSure(delfromData)\n        .then((res) => {\n          this.$Message.success(res.msg);\n          this.tabList.splice(num, 1);\n        })\n        .catch((res) => {\n          this.$Message.error(res.msg);\n        });\n    },\n    // 上传头部token\n    getToken() {\n      this.Token = getCookies('token');\n    },\n    download(row) {\n      let data = {\n        time: row.time,\n      };\n      filesDownloadApi(data)\n        .then((res) => {\n          if (res.data.key) {\n            window.open(Setting.apiBaseURL + '/download?key=' + res.data.key);\n          }\n        })\n        .catch((res) => {\n          this.$Message.error(res);\n        });\n    },\n    // 导出备份记录表\n    exportData() {\n      const columns = this.columns.slice(1, 7);\n      this.$refs.selection.exportCsv({\n        filename: '导出',\n        columns: columns,\n        data: this.tabList2,\n      });\n    },\n    // 全选\n    onSelectTab(selection) {\n      this.selectionList = selection;\n      let tables = [];\n      this.selectionList.map((item) => {\n        tables.push(item.name);\n      });\n      this.dataList = {\n        tables: tables.join(','),\n      };\n    },\n    // 备份表\n    getBackup() {\n      if (this.selectionList.length === 0) {\n        return this.$Message.warning('请选择表');\n      }\n      backupBackupApi(this.dataList)\n        .then(async (res) => {\n          this.$Message.success(res.msg);\n          this.getfileList();\n        })\n        .catch((res) => {\n          this.loading = false;\n          this.$Message.error(res.msg);\n        });\n    },\n    // 备份记录表列表\n    getfileList() {\n      this.loading3 = true;\n      filesListApi()\n        .then(async (res) => {\n          let data = res.data;\n          this.tabList = data.list;\n          this.loading3 = false;\n        })\n        .catch((res) => {\n          this.loading3 = false;\n          this.$Message.error(res.msg);\n        });\n    },\n    // 优化表\n    getOptimize() {\n      if (this.selectionList.length === 0) {\n        return this.$Message.warning('请选择表');\n      }\n      backupOptimizeApi(this.dataList)\n        .then(async (res) => {\n          this.$Message.success(res.msg);\n        })\n        .catch((res) => {\n          this.$Message.error(res.msg);\n        });\n    },\n    // 修复表\n    getRepair() {\n      if (this.selectionList.length === 0) {\n        return this.$Message.warning('请选择表');\n      }\n      backupRepairApi(this.dataList)\n        .then(async (res) => {\n          this.$Message.success(res.msg);\n        })\n        .catch((res) => {\n          this.$Message.error(res.msg);\n        });\n    },\n    // 数据库列表\n    getList() {\n      this.loading = true;\n      backupListApi()\n        .then(async (res) => {\n          let data = res.data;\n          this.tabList2 = data.list;\n          this.loading = false;\n        })\n        .catch((res) => {\n          this.loading = false;\n          this.$Message.error(res.msg);\n        });\n    },\n    // 详情\n    Info(row) {\n      this.rows = row;\n      this.modals = true;\n      this.loading2 = true;\n      let data = {\n        tablename: row.name,\n      };\n      backupReadListApi(data)\n        .then(async (res) => {\n          let data = res.data;\n          this.tabList3 = data.list;\n          this.loading2 = false;\n        })\n        .catch((res) => {\n          this.loading2 = false;\n          this.$Message.error(res.msg);\n        });\n    },\n    isEditMark(row) {\n      row.is_edit = true;\n      this.$nextTick((e) => {\n        this.$refs.mark.focus();\n      });\n    },\n    isEditBlur(row, type) {\n      row.is_edit = false;\n      this.changeMarkData.table = row.name || row.TABLE_NAME;\n      this.changeMarkData.field = row.COLUMN_NAME || '';\n      this.changeMarkData.type = row.COLUMN_TYPE || '';\n      this.changeMarkData.is_field = type;\n      this.changeMarkData.mark = type ? row.COLUMN_COMMENT : row.comment;\n\n      updateMark(this.changeMarkData)\n        .then((res) => {\n          // this.$Message.success(res.msg);\n        })\n        .catch((err) => {\n          this.$Message.error(err.msg);\n        });\n    },\n  },\n};\n</script>\n\n<style scoped lang=\"stylus\">\n.tableBox >>> .ivu-table-header table\n   border none !important\n\n.table-mark{\n  cursor: text;\n}\n.table-mark:hover{\n  border:1px solid #c2c2c2;\n  padding: 3px 5px\n}\n.mark /deep/ .ivu-input{\n    background: #fff;\n    border-radius: .39rem;\n}\n.mark /deep/ .ivu-input, .ivu-input:hover, .ivu-input:focus {\n    border: transparent;\n    box-shadow: none;\n}\n</style>\n"]}]}